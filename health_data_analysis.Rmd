---
title: "Example HDRUK 4C-Readm. Health Data Analysis"
author: "George Melrose"
date: "`r Sys.Date()`"
output:
  ioslides_presentation:
    css: custom_styles.css
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(tidyverse, icd,knitr,
               kableExtra,finalfit,lubridate,data.table,
               janitor,flextable,survival,survminer,cmprsk,
               rmdHelpers)

rm(list = ls())

```

## Descriptive Statistics of Dummy Admitted Patient Care Dataset {.smaller}

-   Dummy patient data used, an approximation of English APC data. 100K rows, 38 variables. 26 Variables based off of 4C_mortality_score/01_data_prep.R script. For example: dialysis; age.factor; hypertension_mhyn. Remaining 12 variables generated by memory and ICD package, such as dates and causes of first readmission. Date range, 1st March 2020 - 1st March 2022.

```{r rates of Readmission, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE}
dummy_data <- read_csv("dummy_data_complete.csv")

dummy_data$date_of_death <- as.Date(dummy_data$date_of_death)

readm <- dummy_data %>% filter(readmission == "Yes")
nrow(readm)

# number of readmissions within 90 days
readm_before_90 <- readm %>%
  filter(
    days_until_readmission <= 90
  ) 

readm_after_90 <- readm %>%
  filter(
    days_until_readmission > 90
  ) 

nrow(readm_before_90)
```


-   **13,500, 13.5%** are readmitted and **8,560, 8.56%** are readmitted within 90 days. Of those readmitted, **63.4%** are readmitted within 90 days of discharge. Not too dissimilar to Ramzi 2022 meta-analyses, **9.79%** prevalence of 90-day readmissions (10.1016/j.ajem.2021.10.059).Docherty et al., 2023 (Scottish data) is much higher at 35.6% of patients after 1 year (https://www.thelancet.com/pdfs/journals/landig/PIIS2589-7500(23)00051-1.pdf). 



```{r deaths before readmission stats, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE}
dead <- dummy_data %>% filter(death == "Yes") 
nrow(dead)
dead_before_readmission <- dead %>% filter(is.na(days_until_readmission))

nrow(dead_before_readmission)

# number of readmissions within 90 days
dead_before_readmission90 <- dead_before_readmission  %>%
  filter(
    days_until_death <= 90
  ) 

nrow(dead_before_readmission90)
```

-   **3,772, 3.77%** patients died in total before readmission and **3,075, 3.08%** died within 90 days of discharge. Of those patients that died before readmission, **81.5%** died within 90 days. 

```{r deaths in total stats, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE}

nrow(dead)

# number of deaths within 90 days

dead_before_90 <- dead %>%
  filter(
    days_until_death <= 90
  ) 

dead_after_90 <- dead %>%
  filter(
    days_until_death > 90
  ) 

nrow(dead_before_90)
```


-   **11,800 , 11.8%** patients died in total and **4,316, 4.32%** died within 90 days of discharge. Of those patients that died, **36.6%** died within 90 days.The prevalence of 90 day post-discharge all-cause mortality dissimilar to Ramzi 2022 figure of **7.63%** (10.1016/j.ajem.2021.10.059).Docherty et al. 2023 (https://www.thelancet.com/pdfs/journals/landig/PIIS2589-7500(23)00051-1.pdf) had 11.7% all-cause mortality at 1 year after index admission. 



```{r events in total stats, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE}
event <- dummy_data %>% filter(death == "Yes" | readmission == "Yes") 
nrow(event)

# number of readmissions within 90 days
event_before_90 <- event  %>%
  filter(
    days_until_death <= 90 | days_until_readmission <= 90
  ) 

nrow(event_before_90)
```


-   **17865 , 17.9%** of patients had an event (a readmission or death or both) and **12,675, 12.7%** had an event within 90 days of discharge. Of those patients that had an event, **70.9%** had an event within 90 days.



## Top 10 Causes of Readmission

```{r Leading Causes of Readmission, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10,fig.height=9.5}

readm_causes <- readm %>% select(`cause of readmission chapter`)

readm_causes <- readm_causes %>% mutate(no.Readmissions = 1)

top <- readm_causes %>%
  group_by(`cause of readmission chapter`) %>%
  count(sort = TRUE) %>%
  ungroup() %>%
  slice(1:10)

top <- top %>% rename('Cause of Readmission Group' = `cause of readmission chapter`, "no.Readmissions" = n)

top <- top %>% mutate(Proportion = no.Readmissions/sum(no.Readmissions) * 100) 
                      
top$Proportion <- signif(top$Proportion, digits = 3)

top2 <- top %>%  
  adorn_totals("row") %>% mutate ("Cumulative Proportion" = cumsum(Proportion))

top2 <-  top2  %>% mutate(Proportion = paste0(Proportion, "%")) %>% mutate(`Cumulative Proportion` = paste0(`Cumulative Proportion`, "%"))

top2$`Cumulative Proportion` <- gsub("199.96%", "", as.character(top2$`Cumulative Proportion` ))

p <- flextable(top2) 

p <- bold(p, bold = TRUE, part = "header")

autofit(p)
```

## Top 10 Causes of Death

```{r Leading Causes of Death, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE}

death_causes <- dead %>% select(`cause of death chapter`)

death_causes <- death_causes %>% mutate(no.Deaths = 1)

top <- death_causes %>%
  group_by(`cause of death chapter`) %>%
  count(sort = TRUE) %>%
  ungroup() %>%
  slice(1:10)

top <- top %>% rename('Cause of Death Group' = `cause of death chapter`, "no.Deaths" = n)

top <- top %>% mutate(Proportion = no.Deaths/sum(no.Deaths) * 100) 
                      
top$Proportion <- signif(top$Proportion, digits = 3)

top2 <- top %>%  
  adorn_totals("row") %>% mutate ("Cumulative Proportion" = cumsum(Proportion))

top2 <-  top2  %>% mutate(Proportion = paste0(Proportion, "%")) %>% mutate(`Cumulative Proportion` = paste0(`Cumulative Proportion`, "%"))

top2$`Cumulative Proportion` <- gsub("199.98%", "", as.character(top2$`Cumulative Proportion` ))

p <- flextable(top2) 

p <- bold(p, bold = TRUE, part = "header")

autofit(p)
```


## Full Cohort Survival Probability for all Deaths {.flexbox .vcenter}

```{r restating factor variables, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE}
yes_no_columns <- c("hypertension_mhyn", "chrincard", "malnutrition_mhyn",
                    "dehydration_vsorres", "diabetes_type_mhyn", "alt_conscious",
                    "hypoxic_target", "o2_rx", "diabetes_combined", "infiltrates_faorres", "dialysis")

dummy_data <- dummy_data %>%
  mutate(across(all_of(yes_no_columns),
                ~ factor(., levels = c("Yes", "No")) %>% relevel(ref = "No")))

# Set "0" as the reference level for no_comorbid
dummy_data$no_comorbid <- factor(dummy_data$no_comorbid, levels = c("0", "1", "2", ">2")) %>% relevel(ref = "0")

ethnicity_levels <- c("White", "South Asian", "East Asian", "Black", "Other Ethnic Minority")

# Set "White" as the reference level for ethnicity_4levels
dummy_data$ethnicity_4levels <- factor(dummy_data$ethnicity_4levels, levels = ethnicity_levels) %>% relevel(ref = "White")
```


```{r full cohort km curve, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=11.5,fig.height=5.25,fig.align='center'}
dummy_data$all_deaths <- ifelse(dummy_data$death == "No", "0", "1")

dummy_data$all_deaths <- as.numeric(dummy_data$all_deaths)

dummy_data$days_until_death <- as.numeric(dummy_data$days_until_death)


dummy_data <- dummy_data %>% mutate('follow_up_time' = coalesce(days_until_death, days_until_readmission))

dummy_data$follow_up_time <- dummy_data$follow_up_time %>% replace_na(2000)

fit_death <- survfit(Surv(dummy_data$follow_up_time, dummy_data$all_deaths) ~ 1, data = dummy_data)

ggsurvplot(fit_death,
           xlim = c(0, 365),
           ylim = c(0, 1),
           break.time.by = 28,
           xlab = "Days since discharge",
           ylab = "Survival Probability",
           pval = TRUE,
           ggtheme = theme_minimal() + theme(
                  panel.grid.major = element_blank(), # Remove major grid lines
                  panel.grid.minor = element_blank(), # Remove minor grid lines
                  panel.background = element_blank(), # Remove panel background
                  plot.background = element_blank(),  # Remove plot background
                  axis.line = element_line(color = "black"), # Keep axis lines if desired
                  axis.title = element_text(size = 20), # Increase axis title size
                  axis.text = element_text(size = 17),  # Increase axis text size
                  legend.text = element_text(size = 20), # Increase legend text size
                  legend.title = element_text(size = 25), # Increase legend title size
                  plot.title = element_text(size = 25), # Increase plot title size
                  plot.subtitle = element_text(size = 20), # Increase plot subtitle size
                  legend.key.size = unit(4, "lines") # Increase legend key size
                ),
           risk.table = FALSE,
           risk.table.y.text.col = TRUE,
           risk.table.height = 0.2,
           risk.table.y.text = FALSE,
           conf.int = TRUE, cumcensor = FALSE, conf.int.style = "step",
           legend.title = element_blank() # Set legend title
)
```

## Different factors' Survival Probability for all Deaths {.flexbox .vcenter}

```{r sex km curve, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=11.5,fig.height=5.3,fig.align = 'center'}

fit_death_sex <- survfit(Surv(dummy_data$follow_up_time , dummy_data$all_deaths) ~ sex , data = dummy_data)

legend_labels <- c("Female", "Male")

ggsurvplot(fit_death_sex,
           xlim = c(0, 365),
           ylim = c(0, 1),
           break.time.by = 28,
           xlab = "Days since discharge",
           ylab = "Survival Probability",
           pval = TRUE,
           ggtheme = theme_minimal() + theme(
                  panel.grid.major = element_blank(), # Remove major grid lines
                  panel.grid.minor = element_blank(), # Remove minor grid lines
                  panel.background = element_blank(), # Remove panel background
                  plot.background = element_blank(),  # Remove plot background
                  axis.line = element_line(color = "black"), # Keep axis lines if desired
                axis.title = element_text(size = 20), # Increase axis title size
                  axis.text = element_text(size = 17),  # Increase axis text size
                  legend.text = element_text(size = 20), # Increase legend text size
                  legend.title = element_text(size = 25), # Increase legend title size
                  plot.title = element_text(size = 25), # Increase plot title size
                  plot.subtitle = element_text(size = 20), # Increase plot subtitle size
                  legend.key.size = unit(4, "lines") # Increase legend key size
                ),
           risk.table = FALSE,
           risk.table.y.text.col = TRUE,
           risk.table.height = 0.2,
           risk.table.y.text = FALSE,
           conf.int = TRUE, cumcensor = FALSE, conf.int.style = "step",pval.coord = c(0, 0.47), pval.method = TRUE, pval.method.coord = c(0, 0.55),
           legend.labs = legend_labels,
           legend.title = "Sex",pval.size = 10, pval.method.size = 10 # Set legend title
)

```

```{r diabetes km curve, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=11.5,fig.height=5.3,fig.align = 'center'}

fit_death_diabetes <- survfit(Surv(dummy_data$follow_up_time , dummy_data$all_deaths) ~ diabetes_type_mhyn , data = dummy_data)


legend_labels <- c("No", "Yes")

ggsurvplot(fit_death_diabetes ,
           xlim = c(0, 365),
           ylim = c(0, 1),
           break.time.by = 28,
           xlab = "Days since discharge",
           ylab = "Survival Probability",
           pval = TRUE,
           ggtheme = theme_minimal() + theme(
                  panel.grid.major = element_blank(), # Remove major grid lines
                  panel.grid.minor = element_blank(), # Remove minor grid lines
                  panel.background = element_blank(), # Remove panel background
                  plot.background = element_blank(),  # Remove plot background
                  axis.line = element_line(color = "black"), # Keep axis lines if desired
                 axis.title = element_text(size = 20), # Increase axis title size
                  axis.text = element_text(size = 17),  # Increase axis text size
                  legend.text = element_text(size = 20), # Increase legend text size
                  legend.title = element_text(size = 25), # Increase legend title size
                  plot.title = element_text(size = 25), # Increase plot title size
                  plot.subtitle = element_text(size = 20), # Increase plot subtitle size
                  legend.key.size = unit(4, "lines") # Increase legend key size
                ),
           risk.table = FALSE,
           risk.table.y.text.col = TRUE,
           risk.table.height = 0.2,
           risk.table.y.text = FALSE,
         conf.int = TRUE, cumcensor = FALSE, conf.int.style = "step",pval.coord = c(0, 0.48), pval.method = TRUE, pval.method.coord = c(0, 0.55),
           legend.labs = legend_labels,
           legend.title = "Diabetes",pval.size = 10, pval.method.size = 10
)

```

```{r age factor km curve, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=11.5,fig.height=5.3,fig.align = 'center'}

fit_death_age <- survfit(Surv(dummy_data$follow_up_time , dummy_data$all_deaths) ~ age.factor , data = dummy_data)

legend_labels <- c("<50", "50-69","70-79","80+")

ggsurvplot(fit_death_age ,
           xlim = c(0, 365),
           ylim = c(0, 1),
           break.time.by = 28,
           xlab = "Days since discharge",
           ylab = "Survival Probability",
           pval = TRUE,
           ggtheme = theme_minimal() + theme(
                  panel.grid.major = element_blank(), # Remove major grid lines
                  panel.grid.minor = element_blank(), # Remove minor grid lines
                  panel.background = element_blank(), # Remove panel background
                  plot.background = element_blank(),  # Remove plot background
                  axis.line = element_line(color = "black"), # Keep axis lines if desired
                  axis.title = element_text(size = 20), # Increase axis title size
                  axis.text = element_text(size = 17),  # Increase axis text size
                  legend.text = element_text(size = 20), # Increase legend text size
                  legend.title = element_text(size = 25), # Increase legend title size
                  plot.title = element_text(size = 25), # Increase plot title size
                  plot.subtitle = element_text(size = 20), # Increase plot subtitle size
                  legend.key.size = unit(4, "lines") # Increase legend key size
                ),
           risk.table = FALSE,
           risk.table.y.text.col = TRUE,
           risk.table.height = 0.2,
           risk.table.y.text = FALSE,
           conf.int = TRUE, cumcensor = FALSE, conf.int.style = "step",pval.coord = c(0, 0.46), pval.method = TRUE, pval.method.coord = c(0, 0.55),
           legend.labs = legend_labels,
           legend.title = "Age",pval.size = 10, pval.method.size = 10 # Set legend title
)

```


```{r comorbidities km curve, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=11.5,fig.height=5.3,fig.align = 'center'}

dummy_data <- dummy_data %>%
  mutate(no_comorbid = factor(no_comorbid, levels = c("0", "1", "2", ">2")))


fit_death_comorbid <- survfit(Surv(dummy_data$follow_up_time , dummy_data$all_deaths) ~ no_comorbid , data = dummy_data)

legend_labels <- c("0","1","2",">2")

ggsurvplot(fit_death_comorbid ,
           xlim = c(0, 365),
           ylim = c(0, 1),
           break.time.by = 28,
           xlab = "Days since discharge",
           ylab = "Survival Probability",
           pval = TRUE,
           ggtheme = theme_minimal() + theme(
                  panel.grid.major = element_blank(), # Remove major grid lines
                  panel.grid.minor = element_blank(), # Remove minor grid lines
                  panel.background = element_blank(), # Remove panel background
                  plot.background = element_blank(),  # Remove plot background
                  axis.line = element_line(color = "black"), # Keep axis lines if desired
                  axis.title = element_text(size = 20), # Increase axis title size
                  axis.text = element_text(size = 17),  # Increase axis text size
                  legend.text = element_text(size = 20), # Increase legend text size
                  legend.title = element_text(size = 25), # Increase legend title size
                  plot.title = element_text(size = 25), # Increase plot title size
                  plot.subtitle = element_text(size = 20), # Increase plot subtitle size
                  legend.key.size = unit(4, "lines") # Increase legend key size
                ),
           risk.table = FALSE,
           risk.table.y.text.col = TRUE,
           risk.table.height = 0.2,
           risk.table.y.text = FALSE,
           conf.int = TRUE, cumcensor = FALSE, conf.int.style = "step",pval.coord = c(0, 0.46), pval.method = TRUE, pval.method.coord = c(0, 0.55),
           legend.labs = legend_labels,
           legend.title = "No.Comorbidities",pval.size = 10, pval.method.size = 10 # Set legend title
)

```


```{r chrincard km curve, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=11.5,fig.height=5.3,fig.align = 'center'}

fit_death_chrincard  <- survfit(Surv(dummy_data$follow_up_time , dummy_data$all_deaths) ~ chrincard  , data = dummy_data)

legend_labels <- c("No", "Yes")

ggsurvplot(fit_death_diabetes ,
           xlim = c(0, 365),
           ylim = c(0, 1),
           break.time.by = 28,
           xlab = "Days since discharge",
           ylab = "Survival Probability",
           pval = TRUE,
           ggtheme = theme_minimal() + theme(
                  panel.grid.major = element_blank(), # Remove major grid lines
                  panel.grid.minor = element_blank(), # Remove minor grid lines
                  panel.background = element_blank(), # Remove panel background
                  plot.background = element_blank(),  # Remove plot background
                  axis.line = element_line(color = "black"), # Keep axis lines if desired
                 axis.title = element_text(size = 20), # Increase axis title size
                  axis.text = element_text(size = 17),  # Increase axis text size
                  legend.text = element_text(size = 20), # Increase legend text size
                  legend.title = element_text(size = 25), # Increase legend title size
                  plot.title = element_text(size = 25), # Increase plot title size
                  plot.subtitle = element_text(size = 20), # Increase plot subtitle size
                  legend.key.size = unit(4, "lines") # Increase legend key size
                ),
           risk.table = FALSE,
           risk.table.y.text.col = TRUE,
           risk.table.height = 0.2,
           risk.table.y.text = FALSE,
         conf.int = TRUE, cumcensor = FALSE, conf.int.style = "step",pval.coord = c(0, 0.47), pval.method = TRUE, pval.method.coord = c(0, 0.56),
           legend.labs = legend_labels,
           legend.title = "Diabetes",pval.size = 10, pval.method.size = 10
)
```



## Cumulative Incidence of Readmissions

```{r all cohort ci readmissions, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.width=10.75,fig.height=5.5,fig.align = 'center'}
cohort <- dummy_data

dead_within_90 <- cohort %>% filter(death == "Yes") 

dead_within_90 <- dead_within_90 %>% filter(days_until_death <= 90) 

cohort$status_1 <- NA

cohort <- cohort %>% mutate(status_1 =  case_when(
readmission == "Yes" ~ "1", TRUE ~ "0" ) )

cohort <- cohort %>% mutate(status_2 =  case_when(
  status_1 == 1  ~ "Readmission",
  TRUE ~ "NA" ) )


ci_fit <- cuminc(cohort$follow_up_time , cohort$status_1)

ciplot <- ci_fit %>% list_modify("Tests" = NULL) %>%
  map_df(`[`, c("time", "est", "var"), .id = "id") %>%
   mutate(Readmission = recode(
    id,
    "1 1" = "Readmission"))  


ggplot(ciplot, aes(x = time, y = est, color = Readmission)) +
  geom_step(lwd = 1.2) +
  scale_y_continuous(limits = c(0, 0.3), labels = scales::percent_format(accuracy = 1)) +  # Format y-axis as percentages
  scale_x_continuous(breaks = seq(0, 365, 28), limits = c(0, 365)) +  # Setting limits here
  theme_minimal() +  # Use theme_minimal for a simple background
  theme(
    plot.title = element_text(size = 25), # Increase plot title size
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.title = element_text(size = 20), # Increase axis title size
    axis.text = element_text(size = 17),  # Increase axis text size
    legend.text = element_text(size = 20), # Increase legend text size
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.background = element_rect(fill = "white", color = NA),  # Ensure background is white and remove panel border
    plot.background = element_rect(fill = "white", color = NA),  # Ensure plot area is white and remove plot border
    axis.line = element_line(color = "black"),  # Keep axis lines
    axis.line.y.right = element_blank(),  # Remove right side axis line
    axis.line.x.top = element_blank()  # Remove top side axis line
  ) +
  labs(
    x = "Days",
    y = "Cumulative readmissions",
    title = "All Patients"
  )

```



```{r sex ci readmissions, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.width=10.75,fig.height=5.5,fig.align = 'center'}

ci_sex <- cuminc(ftime = cohort$follow_up_time , fstatus = cohort$status_1, group= cohort$sex)

ciplot <- ci_sex %>% list_modify("Tests" = NULL) %>%
  map_df(`[`, c("time", "est", "var"), .id = "id") %>%
  mutate(id = recode(
    id,
    "Male 1" = "Male:Readmissions",
    "Female 1" = "Female:Readmissions")
  ) %>%
  separate(id, c("Sex","Event"),":")

ggplot(ciplot, aes(x = time, y = est, color = Sex)) +
  geom_step(lwd = 1.2) +
    scale_y_continuous(limits = c(0, 0.3), labels = scales::percent_format(accuracy = 1)) +  # Format y-axis as percentages
  scale_x_continuous(breaks = seq(0, 365, 28), limits = c(0, 365)) +  # Setting limits here
  theme_minimal() + 
  theme(
    plot.title = element_text(size = 25), # Increase plot title size
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.title = element_text(size = 20), # Increase axis title size
    axis.text = element_text(size = 17),  # Increase axis text size
    legend.text = element_text(size = 20), # Increase legend text size
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.background = element_rect(fill = "white", color = NA),  # Ensure background is white and remove panel border
    plot.background = element_rect(fill = "white", color = NA),  # Ensure plot area is white and remove plot border
    axis.line = element_line(color = "black"),  # Keep axis lines
    axis.line.y.right = element_blank(),  # Remove right side axis line
    axis.line.x.top = element_blank()  # Remove top side axis line
  ) +
  labs(
    x = "Days",
    y = "Cumulative readmissions",
    title = "Stratified by Sex"
  ) +
  annotate("text", x = 0, y = 0.26, hjust = 0,
           label = paste0(
             "Readmissions p-value = ",
             ifelse(ci_sex$Tests[1,2] < .001,
                    "<.001",
                    round(ci_sex$Tests[1,2], 3))),
           size = 10)


```



```{r age ci readmissions, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.width=10.75,fig.height=5.5,fig.align = 'center'}

ci_age <- cuminc(ftime = cohort$follow_up_time , fstatus = cohort$status_1, group= cohort$age.factor)

ciplot <- ci_age %>% list_modify("Tests" = NULL) %>%
  map_df(`[`, c("time", "est", "var"), .id = "id") %>%
  mutate(id = recode(
    id,
    "<50 1" = "<50:Readmissions",
    "50-69 1" = "50-69:Readmissions",
    "70-79 1" = "70-79:Readmissions",
    "80+ 1" = "80+:Readmissions",
    )
  ) %>%
  separate(id, c("Age","Event"),":")

ggplot(ciplot, aes(x = time, y = est, color = Age)) +
  geom_step(lwd = 1.2) +
  ylim(c(0, 0.3)) +
  scale_y_continuous(limits = c(0, 0.3), labels = scales::percent_format(accuracy = 1)) +  # Format y-axis as percentages
  scale_x_continuous(breaks = seq(0, 365, 28), limits = c(0, 365)) +  # Setting limits here
  theme_minimal() + 
  theme(
    plot.title = element_text(size = 25), # Increase plot title size
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.title = element_text(size = 20), # Increase axis title size
    axis.text = element_text(size = 17),  # Increase axis text size
    legend.text = element_text(size = 20), # Increase legend text size
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.background = element_rect(fill = "white", color = NA),  # Ensure background is white and remove panel border
    plot.background = element_rect(fill = "white", color = NA),  # Ensure plot area is white and remove plot border
    axis.line = element_line(color = "black"),  # Keep axis lines
    axis.line.y.right = element_blank(),  # Remove right side axis line
    axis.line.x.top = element_blank()  # Remove top side axis line
  ) +
  labs(
    x = "Days",
    y = "Cumulative readmissions",
    title = "Stratified by Age(factor)"
  ) +
  annotate("text", x = 0, y = 0.27, hjust = 0,
           label = paste0(
             "Readmissions p-value = ",
             ifelse(ci_age$Tests[1,2] < .001,
                    "<.001",
                    round(ci_age$Tests[1,2], 3))),
           size = 7.5)


```





```{r comorbidities ci readmissions, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.width=10.75,fig.height=5.5,fig.align = 'center'}

ci_comorbid <- cuminc(ftime = cohort$follow_up_time , fstatus = cohort$status_1, group= cohort$no_comorbid)

ciplot <- ci_comorbid %>% list_modify("Tests" = NULL) %>%
  map_df(`[`, c("time", "est", "var"), .id = "id") %>%
  mutate(id = recode(
    id,
    ">2 1" = ">2:Readmissions",
    "0 1" = "0:Readmissions",
    "1 1" = "1:Readmissions",
    "2 1" = "2:Readmissions",
    )
  ) %>%
  separate(id, c("No.Comorbidities","Event"),":")

ggplot(ciplot, aes(x = time, y = est, color = No.Comorbidities)) +
  geom_step(lwd = 1.2) +
  scale_y_continuous(limits = c(0, 0.3), labels = scales::percent_format(accuracy = 1)) +  # Format y-axis as percentages
  scale_x_continuous(breaks = seq(0, 365, 28), limits = c(0, 365)) +  # Setting limits here
  theme_minimal() + 
  theme(
    plot.title = element_text(size = 25), # Increase plot title size
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.title = element_text(size = 20), # Increase axis title size
    axis.text = element_text(size = 17),  # Increase axis text size
    legend.text = element_text(size = 20), # Increase legend text size
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.background = element_rect(fill = "white", color = NA),  # Ensure background is white and remove panel border
    plot.background = element_rect(fill = "white", color = NA),  # Ensure plot area is white and remove plot border
    axis.line = element_line(color = "black"),  # Keep axis lines
    axis.line.y.right = element_blank(),  # Remove right side axis line
    axis.line.x.top = element_blank()  # Remove top side axis line
  ) +
  labs(
    x = "Days",
    y = "Cumulative readmissions",
    title = "Stratified by No.Comorbidities"
  ) +
  annotate("text", x = 0, y = 0.27, hjust = 0,
           label = paste0(
             "Readmissions p-value = ",
             ifelse(ci_comorbid$Tests[1,2] < .001,
                    "<.001",
                    round(ci_comorbid$Tests[1,2], 3))),
           size = 7.5)

```







## Cumulative Incidence of Deaths
```{r all cohort CI deaths, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.width=10.75,fig.height=5.5,fig.align = 'center'}
cohort$status_1 <- NA

cohort <- cohort %>% mutate(status_1 =  case_when(
  death == "Yes"  ~ "1",
  TRUE ~ "0" ) )

cohort <- cohort %>% mutate(status_2 =  case_when(
  status_1 == 1  ~ "Death",
   TRUE ~ "NA" ) )


ci_fit <- cuminc(cohort$follow_up_time , cohort$status_1)

ciplot <- ci_fit %>% list_modify("Tests" = NULL) %>%
  map_df(`[`, c("time", "est", "var"), .id = "id") %>%
   mutate(Death = recode(
    id,
    "1 1" = "Death"))  

ggplot(ciplot, aes(x = time, y = est, color = Death)) +
  geom_step(lwd = 1.2) +
  ylim(c(0,0.1)) +
  coord_cartesian(xlim = c(0,90))  +
  scale_x_continuous(breaks = seq(0,90,10)) +
  theme_classic() + theme(plot.title = element_text(size = 14),
                          legend.title = element_blank(),
                          legend.position = "bottom") +
  labs(x = "Days",
       y = "Cumulative incidence of Deaths",
       title = "CI Plot of Deaths across Whole Cohort")  


ggplot(ciplot, aes(x = time, y = est, color = Death)) +
  geom_step(lwd = 1.2) +
  scale_y_continuous(limits = c(0, 0.3), labels = scales::percent_format(accuracy = 1)) +  # Format y-axis as percentages
  scale_x_continuous(breaks = seq(0, 365, 28), limits = c(0, 365)) +  # Setting limits here
  theme_minimal() +  # Use theme_minimal for a simple background
  theme(
    plot.title = element_text(size = 25), # Increase plot title size
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.title = element_text(size = 20), # Increase axis title size
    axis.text = element_text(size = 17),  # Increase axis text size
    legend.text = element_text(size = 20), # Increase legend text size
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.background = element_rect(fill = "white", color = NA),  # Ensure background is white and remove panel border
    plot.background = element_rect(fill = "white", color = NA),  # Ensure plot area is white and remove plot border
    axis.line = element_line(color = "black"),  # Keep axis lines
    axis.line.y.right = element_blank(),  # Remove right side axis line
    axis.line.x.top = element_blank()  # Remove top side axis line
  ) +
  labs(
    x = "Days",
    y = "Cumulative deaths",
    title = "All Patients"
  )

```

```{r all cohort CI deaths, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.width=10.75,fig.height=5.5,fig.align = 'center'}
ci_sex <- cuminc(ftime = cohort$follow_up_time , fstatus = cohort$status_1, group= cohort$sex)

ciplot <- ci_sex %>% list_modify("Tests" = NULL) %>%
  map_df(`[`, c("time", "est", "var"), .id = "id") %>%
  mutate(id = recode(
    id,
    "Male 1" = "Male:Deaths",
    "Female 1" = "Female:Deaths")
  ) %>%
  separate(id, c("Sex","Event"),":")
  
plot <- ggplot(ciplot, aes(x = time, y = est, color = Sex)) +
  geom_step(lwd = 1.2, aes(linetype = Event)) +
  ylim(c(0,0.12)) +
  xlim (c(0, 90)) +
  theme_classic() + theme(plot.title = element_text(size = 14),
                          legend.title = element_blank(),
                          legend.position = "bottom") +
  labs(x = "Days",
       y = "Cumulative incidence",
       title = "CI Plot of Deaths by Sex") +
  annotate("text", x = 0, y = 0.04, hjust = 0,
           label = paste0(
             "Deaths p-value = ",
             ifelse(ci_sex$Tests[1,2] < .001,
                    "<.001",
                    round(ci_sex$Tests[1,2], 3)))) 

fit <- survfit(Surv(follow_up_time, ifelse(status_1 != 0,1,0)) ~ sex, data = cohort)

num <- ggsurvplot(
    fit = fit,
    risk.table = TRUE,
    risk.table.y.text = FALSE,
    risk.table.fontsize = 3.2,
    tables.theme = theme_survminer(font.main = 10),
    title = "Test",
    xlim = c(0, 90),
    break.time.by = 10
  )

# cause_specific = surv_fit(
#     Surv(follow_up_time, ifelse(status_1 == 1, 1, 0)) ~ sex,
#     data = cohort
#   )
# 
# ci_tab_cause_specific = ggsurvplot(
#     fit = cause_specific,
#     risk.table = TRUE,
#     cumevents = TRUE,
#     risk.table.y.text = FALSE,
#     risk.table.fontsize = 3.2,
#     tables.theme = theme_survminer(font.main = 10),
#     title = "Test",
#     xlim =  c(0, 90),
#     break.time.by = 10
#   )

cowplot::plot_grid(plot, num$table + theme_cleantable(),
                   nrow = 2, rel_heights = c(4,1),
                   align = "v", axis = "b")
```


## Cumulative Incidence of Readmissions and Deaths

```{r Setting up CI parameters, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.width=10.75,fig.height=5.5,fig.align = 'center'}
cohort <- dummy_data 

cohort$status_1 <- NA

cohort <- cohort %>% mutate(status_1 =  case_when(
  readmission == "Yes"  ~ "1",
  death == "Yes" ~ "2", TRUE ~ "0" ) )

cohort <- cohort %>% mutate(status_2 =  case_when(
  status_1 == 1  ~ "Readmission",
  status_1 == 2 ~ "Death", TRUE ~ "NA" ) )


ci_fit <- cuminc(cohort$follow_up_time , cohort$status_1)

ciplot <- ci_fit %>% list_modify("Tests" = NULL) %>%
  map_df(`[`, c("time", "est", "var"), .id = "id") %>%
   mutate(Readmission = recode(
    id,
    "1 1" = "Readmission",
    "1 2" = "Death"))  

ggplot(ciplot, aes(x = time, y = est, color = Readmission)) +
  geom_step(lwd = 1.2) +
  ylim(c(0,0.1)) +
  coord_cartesian(xlim = c(0,90))  +
  scale_x_continuous(breaks = seq(0,90,10)) +
  theme_classic() + theme(plot.title = element_text(size = 14),
                          legend.title = element_blank(),
                          legend.position = "bottom") +
  labs(x = "Days",
       y = "Cumulative incidence",
       title = "CI Plot of Readmissions & Deaths across Whole Cohort")  
```

```{r By sex part two, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10.7,fig.height=5.3,fig.align = 'center'}
ci_sex <- cuminc(ftime = cohort$follow_up_time , fstatus = cohort$status_1, group= cohort$sex)

ciplot <- ci_sex %>% list_modify("Tests" = NULL) %>%
  map_df(`[`, c("time", "est", "var"), .id = "id") %>%
  mutate(id = recode(
    id,
    "Male 2" = "Male:Deaths",
    "Female 2" = "Female:Deaths",
    "Male 1" = "Male:Readmissions",
    "Female 1" = "Female:Readmissions")
  ) %>%
  separate(id, c("Sex","Event"),":")
  
plot <- ggplot(ciplot, aes(x = time, y = est, color = Sex)) +
  geom_step(lwd = 1.2, aes(linetype = Event)) +
  ylim(c(0,0.12)) +
  xlim (c(0, 90)) +
  theme_classic() + theme(plot.title = element_text(size = 14),
                          legend.title = element_blank(),
                          legend.position = "bottom") +
  labs(x = "Days",
       y = "Cumulative incidence",
       title = "CI Plot of Readmissions & Deaths by Sex") +
  annotate("text", x = 0, y = 0.04, hjust = 0,
           label = paste0(
             "Deaths p-value = ",
             ifelse(ci_sex$Tests[1,2] < .001,
                    "<.001",
                    round(ci_sex$Tests[1,2], 3)))) +
  annotate("text", x = 0, y = 0.06, hjust = 0,
           label = paste0(
             "Readmissions p-value = ",
             ifelse(ci_sex$Tests[2,2] < .001,
                    "<.001",
                    round(ci_sex$Tests[2,2], 3))))

fit <- survfit(Surv(follow_up_time, ifelse(status_1 != 0,1,0)) ~ sex, data = cohort)

num <- ggsurvplot(
    fit = fit,
    risk.table = TRUE,
    risk.table.y.text = FALSE,
    risk.table.fontsize = 3.2,
    tables.theme = theme_survminer(font.main = 10),
    title = "Test",
    xlim = c(0, 90),
    break.time.by = 10
  )

# cause_specific = surv_fit(
#     Surv(follow_up_time, ifelse(status_1 == 1, 1, 0)) ~ sex,
#     data = cohort
#   )
# 
# ci_tab_cause_specific = ggsurvplot(
#     fit = cause_specific,
#     risk.table = TRUE,
#     cumevents = TRUE,
#     risk.table.y.text = FALSE,
#     risk.table.fontsize = 3.2,
#     tables.theme = theme_survminer(font.main = 10),
#     title = "Test",
#     xlim =  c(0, 90),
#     break.time.by = 10
#   )

cowplot::plot_grid(plot, num$table + theme_cleantable(),
                   nrow = 2, rel_heights = c(4,1),
                   align = "v", axis = "b")
```


```{r By hypertension, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10.7,fig.height=5.3,fig.align = 'center'}
ci_hypertension <- cuminc(ftime = cohort$follow_up_time , fstatus = cohort$status_1, group= cohort$hypertension_mhyn)

ciplot <- ci_hypertension  %>% list_modify("Tests" = NULL) %>%
  map_df(`[`, c("time", "est", "var"), .id = "id") %>%
  mutate(id = recode(
    id,
    "No 2" = "No:Deaths",
    "Yes 2" = "Yes:Deaths",
    "No 1" = "No:Readmissions",
    "Yes 1" = "Yes:Readmissions")
  ) %>%
  separate(id, c("Hypertension","Event"),":")
  
plot <- ggplot(ciplot, aes(x = time, y = est, color = Hypertension)) +
  geom_step(lwd = 1.2, aes(linetype = Event)) +
  ylim(c(0,0.12)) +
  xlim (c(0, 90)) +
  theme_classic() + theme(plot.title = element_text(size = 14),
                          legend.title = element_blank(),
                          legend.position = "bottom") +
  labs(x = "Days",
       y = "Cumulative incidence",
       title = "CI Plot of Readmissions & Deaths by Hypertension (Yes/No)") +
  annotate("text", x = 0, y = 0.04, hjust = 0,
           label = paste0(
             "Deaths p-value = ",
             ifelse(ci_hypertension$Tests[1,2] < .001,
                    "<.001",
                    round(ci_hypertension$Tests[1,2], 3)))) +
  annotate("text", x = 0, y = 0.06, hjust = 0,
           label = paste0(
             "Readmissions p-value = ",
             ifelse(ci_hypertension$Tests[2,2] < .001,
                    "<.001",
                    round(ci_hypertension$Tests[2,2], 3))))

fit <- survfit(Surv(follow_up_time, ifelse(status_1 != 0,1,0)) ~ hypertension_mhyn, data = cohort)

num <- ggsurvplot(
    fit = fit,
    risk.table = TRUE,
    risk.table.y.text = FALSE,
    risk.table.fontsize = 3.2,
    tables.theme = theme_survminer(font.main = 10),
    title = "Test",
    xlim = c(0, 90),
    break.time.by = 10
  )

# cause_specific = surv_fit(
#     Surv(follow_up_time, ifelse(status_1 == 1, 1, 0)) ~ sex,
#     data = cohort
#   )
# 
# ci_tab_cause_specific = ggsurvplot(
#     fit = cause_specific,
#     risk.table = TRUE,
#     cumevents = TRUE,
#     risk.table.y.text = FALSE,
#     risk.table.fontsize = 3.2,
#     tables.theme = theme_survminer(font.main = 10),
#     title = "Test",
#     xlim =  c(0, 90),
#     break.time.by = 10
#   )

cowplot::plot_grid(plot, num$table + theme_cleantable(),
                   nrow = 2, rel_heights = c(4,1),
                   align = "v", axis = "b")
```
```{r By Age, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10.7,fig.height=5.3,fig.align = 'center'}
ci_age <- cuminc(ftime = cohort$follow_up_time , fstatus = cohort$status_1, group= cohort$age.factor)

ciplot <- ci_age  %>% list_modify("Tests" = NULL) %>%
  map_df(`[`, c("time", "est", "var"), .id = "id") %>%
  mutate(id = recode(
    id,
    "<50 2" = "<50:Deaths",
    "50-69 2" = "50-69:Deaths",
    "70-79 2" = "70-79:Deaths",
    "80+ 2" = "80+:Deaths",
    "<50 1" = "<50:Readmissions",
    "50-69 1" = "50-69:Readmissions",
    "70-79 1" = "70-79:Readmissions",
    "80+ 1" = "80+:Readmissions",)
  ) %>%
  separate(id, c("Age","Event"),":")
  
plot <- ggplot(ciplot, aes(x = time, y = est, color = Age)) +
  geom_step(lwd = 1.2, aes(linetype = Event)) +
  ylim(c(0,0.09)) +
  xlim (c(0, 90)) +
  theme_classic() + theme(plot.title = element_text(size = 14),
                          legend.title = element_blank(),
                          legend.position = "bottom") +
  labs(x = "Days",
       y = "Cumulative incidence",
       title = "CI Plot of Readmissions & Deaths by Age") +
  annotate("text", x = 0, y = 0.04, hjust = 0,
           label = paste0(
             "Deaths p-value = ",
             ifelse(ci_age$Tests[1,2] < .001,
                    "<.001",
                    round(ci_age$Tests[1,2], 3)))) +
  annotate("text", x = 0, y = 0.06, hjust = 0,
           label = paste0(
             "Readmissions p-value = ",
             ifelse(ci_age$Tests[2,2] < .001,
                    "<.001",
                    round(ci_age$Tests[2,2], 3))))

fit <- survfit(Surv(follow_up_time, ifelse(status_1 != 0,1,0)) ~ age.factor, data = cohort)

num <- ggsurvplot(
    fit = fit,
    risk.table = TRUE,
    risk.table.y.text = FALSE,
    risk.table.fontsize = 3.2,
    tables.theme = theme_survminer(font.main = 10),
    title = "Test",
    xlim = c(0, 90),
    break.time.by = 10
  )

# cause_specific = surv_fit(
#     Surv(follow_up_time, ifelse(status_1 == 1, 1, 0)) ~ sex,
#     data = cohort
#   )
# 
# ci_tab_cause_specific = ggsurvplot(
#     fit = cause_specific,
#     risk.table = TRUE,
#     cumevents = TRUE,
#     risk.table.y.text = FALSE,
#     risk.table.fontsize = 3.2,
#     tables.theme = theme_survminer(font.main = 10),
#     title = "Test",
#     xlim =  c(0, 90),
#     break.time.by = 10
#   )

cowplot::plot_grid(plot, num$table + theme_cleantable(),
                   nrow = 2, rel_heights = c(4,1),
                   align = "v", axis = "b")
```




```{r, warning=FALSE, message=FALSE,}
# Set "White" as the reference level
dummy_data <- dummy_data %>%
  mutate(ethnicity_4levels = factor(ethnicity_4levels)) %>%
  mutate(ethnicity_4levels = relevel(ethnicity_4levels, ref = "White"))

dummy_data <- dummy_data %>%
  mutate(no_comorbid = factor(no_comorbid, levels = c("0", "1", "2", ">2")))

dummy_data <- dummy_data %>%
  mutate(Clinical_Frailty_Index = factor(Clinical_Frailty_Index, levels = 1:9))

dummy_data <- dummy_data %>%
  mutate(IMD = factor(IMD, levels = 1:10))

dummy_data <- dummy_data %>%
  mutate(sex = factor(sex)) %>%
  mutate(sex = relevel(sex, ref = "Male"))

```


```{r, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.align = 'center',fig.width=11,fig.height=5}

dummy_data$readm_within_90 <- ifelse(dummy_data$days_until_readmission <= 90, "1", "0")

dummy_data$readm_within_90 <- as.numeric(dummy_data$readm_within_90)

dummy_data$readm_within_90 <- dummy_data$readm_within_90 %>% replace_na(0)

dummy_data$readmission_time <- dummy_data$readmission_time %>% replace_na(2000)



dependent = "Surv(days_until_readmission, readm_within_90 )"
dependent_label = "Post-discharge readmission"

vars_multi = c("age.factor","sex","ethnicity_4levels","IMD","Clinical_Frailty_Index")


tab = dummy_data %>% 
  finalfit(dependent, vars_multi, metrics = TRUE, add_dependent_label = FALSE)

mykable = function(x){
    knitr::kable(x, row.names = FALSE, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r"))
}

# Your data manipulation and kable code
# result <- tab[[1]] %>%
#   rename(!!{{ dependent_label }} := label) %>%
#   rename(" " = levels) %>%
#   rename("  " = all)

# Apply mykable to the result
# mykable(result)

# tab[[1]] %>%
#   rename({{dependent_label}} := label) %>%
#   rename(" " = levels) %>%
#   rename("  " = all) %>%
#   mykable()
```


## Cox-proportional Hazards Regression - All Causes of Readmission within 90 Days HR Plot {.flexbox .vcenter .smaller}

```{r, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10,fig.height=5,fig.align = 'center'}

dummy_data %>% 
  hr_plot(dependent, vars_multi,
          breaks = c(0.03,0.1,0.3,1,3,10),
          remove_ref = TRUE,
          column_space = c(-1,0,0.75),
          table_text_size = 3,
          title_text_size = 16,
          dependent_label = dependent_label) 

tab[[2]] %>% knitr::kable()

```



```{r}
dummy_data$age.factor <- dummy_data$age.factor %>% ff_label("Age group, years")

dummy_data$sex <- dummy_data$sex %>% ff_label("Sex")

dummy_data$ethnicity_4levels <- dummy_data$ethnicity_4levels  %>% ff_label("Ethnicity")

dummy_data$Clinical_Frailty_Index<- dummy_data$Clinical_Frailty_Index %>% ff_label("Clinial Frailty Index")

dummy_data$IMD<- dummy_data$IMD %>% ff_label("UK-level decile for Index of Multiple Deprivation")

dummy_data$diabetes_type_mhyn <- dummy_data$diabetes_type_mhyn %>% ff_label("Diabetes Present (Yes/No)")

dummy_data$hypertension_mhyn <- dummy_data$hypertension_mhyn %>% ff_label("Hypertension Present (Yes/No)")

dummy_data$malnutrition_mhyn <- dummy_data$malnutrition_mhyn %>% ff_label("Malnutrition Present (Yes/No)")

dummy_data$no_comorbid <- dummy_data$no_comorbid %>% ff_label("No.Comorbidities")

dummy_data$chrincard <- dummy_data$chrincard %>% ff_label("Chronic Cardiac Disease Present (Yes/No)")


```








```{r, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.align = 'center',fig.width=11,fig.height=5}

dummy_data$readm <- ifelse(dummy_data$readmission == "Yes", "1", "0")

dummy_data$readm <- as.numeric(dummy_data$readm)

dummy_data$readm<- dummy_data$readm %>% replace_na(0)

dummy_data$readmission_time <- dummy_data$readmission_time %>% replace_na(2000)



dependent = "Surv(days_until_readmission, readm)"
dependent_label = "Post-discharge readmission"

vars_multi = c("age.factor","sex","ethnicity_4levels","IMD","no_comorbid","diabetes_type_mhyn",
               "hypertension_mhyn","malnutrition_mhyn","Clinical_Frailty_Index","chrincard")


tab = dummy_data %>% 
  finalfit(dependent, vars_multi, metrics = TRUE, add_dependent_label = FALSE)

mykable = function(x){
    knitr::kable(x, row.names = FALSE, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r"))
}

# Your data manipulation and kable code
# result <- tab[[1]] %>%
#   rename(!!{{ dependent_label }} := label) %>%
#   rename(" " = levels) %>%
#   rename("  " = all)

# Apply mykable to the result
# mykable(result)

# tab[[1]] %>%
#   rename({{dependent_label}} := label) %>%
#   rename(" " = levels) %>%
#   rename("  " = all) %>%
#   mykable()
```




```{r, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10,fig.height=5,fig.align = 'center'}

dummy_data %>% 
  hr_plot(dependent, vars_multi,
          breaks = c(0.03,0.1,0.3,1,3,10),
          remove_ref = TRUE,
          column_space = c(-1,0,0.75),
          table_text_size = 3,
          title_text_size = 16,
          dependent_label = dependent_label) 

tab[[2]] %>% knitr::kable()

```








```{r, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.align = 'center',fig.width=11,fig.height=5}


dependent = "Surv(days_until_readmission, readm)"
dependent_label = "Post-discharge readmission"

vars_multi = c("age.factor","sex","ethnicity_4levels","diabetes_type_mhyn",
               "chrincard")


tab = dummy_data %>% 
  finalfit(dependent, vars_multi, metrics = TRUE, add_dependent_label = FALSE)

mykable = function(x){
    knitr::kable(x, row.names = FALSE, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r"))
}

# Your data manipulation and kable code
# result <- tab[[1]] %>%
#   rename(!!{{ dependent_label }} := label) %>%
#   rename(" " = levels) %>%
#   rename("  " = all)

# Apply mykable to the result
# mykable(result)

# tab[[1]] %>%
#   rename({{dependent_label}} := label) %>%
#   rename(" " = levels) %>%
#   rename("  " = all) %>%
#   mykable()
```




```{r, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10,fig.height=5,fig.align = 'center'}

dummy_data %>% 
  hr_plot(dependent, vars_multi,
          breaks = c(0.03,0.1,0.3,1,3,10),
          remove_ref = TRUE,
          column_space = c(-1,0,0.75),
          table_text_size = 3,
          title_text_size = 16,
          dependent_label = dependent_label) 

tab[[2]] %>% knitr::kable()

```







```{r, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.align = 'center',fig.width=11,fig.height=5}

dummy_data$readm_num <- ifelse(dummy_data$readmission == "Yes", "1", "0")

dummy_data$readm_num <- as.numeric(dummy_data$readm_num)

dummy_data$readm_num <- dummy_data$readm_num %>% replace_na(0)

dummy_data$readmission_time <- dummy_data$readmission_time %>% replace_na(2000)



dependent = "Surv(days_until_readmission, readm_num )"
dependent_label = "Post-discharge readmission"

vars_multi = c("age.factor","sex","chrincard", "diabetes_combined","dialysis",
               "ethnicity_4levels","hypertension_mhyn",
               "no_comorbid","alt_conscious")


tab = dummy_data %>% 
  finalfit(dependent, vars_multi, metrics = TRUE, add_dependent_label = FALSE)

mykable = function(x){
    knitr::kable(x, row.names = FALSE, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r"))
}

# Your data manipulation and kable code
# result <- tab[[1]] %>%
#   rename(!!{{ dependent_label }} := label) %>%
#   rename(" " = levels) %>%
#   rename("  " = all)

# Apply mykable to the result
# mykable(result)

# tab[[1]] %>%
#   rename({{dependent_label}} := label) %>%
#   rename(" " = levels) %>%
#   rename("  " = all) %>%
#   mykable()
```


## Cox-proportional Hazards Regression - All Causes of Readmission HR Plot {.flexbox .vcenter .smaller}

```{r, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10,fig.height=5,fig.align = 'center'}

dummy_data %>% 
  hr_plot(dependent, vars_multi,
          breaks = c(0.03,0.1,0.3,1,3,10),
          remove_ref = TRUE,
          column_space = c(-1,0,0.75),
          table_text_size = 3,
          title_text_size = 16,
          dependent_label = dependent_label) 

tab[[2]] %>% knitr::kable()

```


```{r, warning=FALSE, message=FALSE, include = FALSE, echo = FALSE,fig.align = 'center',fig.width=11,fig.height=5}

falls_fractures <- c(
    "W00", "W01", "W02", "W03", "W04", "W05", "W06", "W07", "W08", "W09", "W10", "W11", "W12", "W13", "W14", "W15", 
    "W16", "W17", "W18", "W19", 
    "S12", "S13", "S14", "S15", "S22", "S23", "S24", "S32", "S33", "S34", "S42", "S43", "S44", "S52", "S53", "S54", 
    "S62", "S63", "S64", "S72", "S73", "S74", "S82", "S83", "S84", "S92", "S93", "S94"
)



dummy_data$readm_ff <- ifelse(dummy_data$cause_of_readmission %in% falls_fractures, "1", "0")

dummy_data$readm_ff <- as.factor(dummy_data$readm_ff)

dummy_data$readm_ff <- as.numeric(dummy_data$readm_ff)

dummy_data$readm_ff <- dummy_data$readm_ff %>% replace_na(0)

dummy_data$readmission_time <- dummy_data$readmission_time %>% replace_na(2000)



dependent = "Surv(days_until_readmission, readm_ff)"
dependent_label = "Post-discharge falls & fracture readmission"

vars_multi = c("age.factor","sex","ethnicity_4levels","IMD","no_comorbid","diabetes_type_mhyn",
               "hypertension_mhyn","malnutrition_mhyn","Clinical_Frailty_Index","chrincard")


tab = dummy_data %>% 
  finalfit(dependent, vars_multi, metrics = TRUE, add_dependent_label = FALSE)

mykable = function(x){
    knitr::kable(x, row.names = FALSE, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r"))
}

# Your data manipulation and kable code
# result <- tab[[1]] %>%
#   rename(!!{{ dependent_label }} := label) %>%
#   rename(" " = levels) %>%
#   rename("  " = all)

# Apply mykable to the result
# mykable(result)

# tab[[1]] %>%
#   rename({{dependent_label}} := label) %>%
#   rename(" " = levels) %>%
#   rename("  " = all) %>%
#   mykable()
```


## Cox-proportional Hazards Regression - Falls and Fractures Causes of Readmission HR Plot {.flexbox .vcenter .smaller}

```{r, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10,fig.height=5,fig.align = 'center'}

dummy_data %>% 
  hr_plot(dependent, vars_multi,
          breaks = c(0.03,0.1,0.3,1,3,10),
          remove_ref = TRUE,
          column_space = c(-1,0,0.75),
          table_text_size = 3,
          title_text_size = 16,
          dependent_label = dependent_label) 

tab[[2]] %>% knitr::kable()

```